<?php
class Twig_NodeVisitor_Optimizer implements Twig_NodeVisitorInterface { const OPTIMIZE_ALL = -1; const OPTIMIZE_NONE = 0; const OPTIMIZE_FOR = 2; const OPTIMIZE_RAW_FILTER = 4; const OPTIMIZE_VAR_ACCESS = 8; protected $loops = array(); protected $loopsTargets = array(); protected $optimizers; protected $prependedNodes = array(); protected $inABody = false; public function __construct($sp8ee00a = -1) { if (!is_int($sp8ee00a) || $sp8ee00a > (self::OPTIMIZE_FOR | self::OPTIMIZE_RAW_FILTER | self::OPTIMIZE_VAR_ACCESS)) { throw new InvalidArgumentException(sprintf('Optimizer mode "%s" is not valid.', $sp8ee00a)); } $this->optimizers = $sp8ee00a; } public function enterNode(Twig_NodeInterface $spcefb62, Twig_Environment $spf4b92b) { if (self::OPTIMIZE_FOR === (self::OPTIMIZE_FOR & $this->optimizers)) { $this->enterOptimizeFor($spcefb62, $spf4b92b); } if (PHP_VERSION_ID < 50400 && self::OPTIMIZE_VAR_ACCESS === (self::OPTIMIZE_VAR_ACCESS & $this->optimizers) && !$spf4b92b->isStrictVariables() && !$spf4b92b->hasExtension('sandbox')) { if ($this->inABody) { if (!$spcefb62 instanceof Twig_Node_Expression) { if (get_class($spcefb62) !== 'Twig_Node') { array_unshift($this->prependedNodes, array()); } } else { $spcefb62 = $this->optimizeVariables($spcefb62, $spf4b92b); } } elseif ($spcefb62 instanceof Twig_Node_Body) { $this->inABody = true; } } return $spcefb62; } public function leaveNode(Twig_NodeInterface $spcefb62, Twig_Environment $spf4b92b) { $spedbef4 = $spcefb62 instanceof Twig_Node_Expression; if (self::OPTIMIZE_FOR === (self::OPTIMIZE_FOR & $this->optimizers)) { $this->leaveOptimizeFor($spcefb62, $spf4b92b); } if (self::OPTIMIZE_RAW_FILTER === (self::OPTIMIZE_RAW_FILTER & $this->optimizers)) { $spcefb62 = $this->optimizeRawFilter($spcefb62, $spf4b92b); } $spcefb62 = $this->optimizePrintNode($spcefb62, $spf4b92b); if (self::OPTIMIZE_VAR_ACCESS === (self::OPTIMIZE_VAR_ACCESS & $this->optimizers) && !$spf4b92b->isStrictVariables() && !$spf4b92b->hasExtension('sandbox')) { if ($spcefb62 instanceof Twig_Node_Body) { $this->inABody = false; } elseif ($this->inABody) { if (!$spedbef4 && get_class($spcefb62) !== 'Twig_Node' && ($sp8fa389 = array_shift($this->prependedNodes))) { $sp6619de = array(); foreach (array_unique($sp8fa389) as $sp3eec35) { $sp6619de[] = new Twig_Node_SetTemp($sp3eec35, $spcefb62->getLine()); } $sp6619de[] = $spcefb62; $spcefb62 = new Twig_Node($sp6619de); } } } return $spcefb62; } protected function optimizeVariables(Twig_NodeInterface $spcefb62, Twig_Environment $spf4b92b) { if ('Twig_Node_Expression_Name' === get_class($spcefb62) && $spcefb62->isSimple()) { $this->prependedNodes[0][] = $spcefb62->getAttribute('name'); return new Twig_Node_Expression_TempName($spcefb62->getAttribute('name'), $spcefb62->getLine()); } return $spcefb62; } protected function optimizePrintNode(Twig_NodeInterface $spcefb62, Twig_Environment $spf4b92b) { if (!$spcefb62 instanceof Twig_Node_Print) { return $spcefb62; } if ($spcefb62->getNode('expr') instanceof Twig_Node_Expression_BlockReference || $spcefb62->getNode('expr') instanceof Twig_Node_Expression_Parent) { $spcefb62->getNode('expr')->setAttribute('output', true); return $spcefb62->getNode('expr'); } return $spcefb62; } protected function optimizeRawFilter(Twig_NodeInterface $spcefb62, Twig_Environment $spf4b92b) { if ($spcefb62 instanceof Twig_Node_Expression_Filter && 'raw' == $spcefb62->getNode('filter')->getAttribute('value')) { return $spcefb62->getNode('node'); } return $spcefb62; } protected function enterOptimizeFor(Twig_NodeInterface $spcefb62, Twig_Environment $spf4b92b) { if ($spcefb62 instanceof Twig_Node_For) { $spcefb62->setAttribute('with_loop', false); array_unshift($this->loops, $spcefb62); array_unshift($this->loopsTargets, $spcefb62->getNode('value_target')->getAttribute('name')); array_unshift($this->loopsTargets, $spcefb62->getNode('key_target')->getAttribute('name')); } elseif (!$this->loops) { return; } elseif ($spcefb62 instanceof Twig_Node_Expression_Name && 'loop' === $spcefb62->getAttribute('name')) { $spcefb62->setAttribute('always_defined', true); $this->addLoopToCurrent(); } elseif ($spcefb62 instanceof Twig_Node_Expression_Name && in_array($spcefb62->getAttribute('name'), $this->loopsTargets)) { $spcefb62->setAttribute('always_defined', true); } elseif ($spcefb62 instanceof Twig_Node_BlockReference || $spcefb62 instanceof Twig_Node_Expression_BlockReference) { $this->addLoopToCurrent(); } elseif ($spcefb62 instanceof Twig_Node_Include && !$spcefb62->getAttribute('only')) { $this->addLoopToAll(); } elseif ($spcefb62 instanceof Twig_Node_Expression_Function && 'include' === $spcefb62->getAttribute('name') && (!$spcefb62->getNode('arguments')->hasNode('with_context') || false !== $spcefb62->getNode('arguments')->getNode('with_context')->getAttribute('value'))) { $this->addLoopToAll(); } elseif ($spcefb62 instanceof Twig_Node_Expression_GetAttr && (!$spcefb62->getNode('attribute') instanceof Twig_Node_Expression_Constant || 'parent' === $spcefb62->getNode('attribute')->getAttribute('value')) && (true === $this->loops[0]->getAttribute('with_loop') || $spcefb62->getNode('node') instanceof Twig_Node_Expression_Name && 'loop' === $spcefb62->getNode('node')->getAttribute('name'))) { $this->addLoopToAll(); } } protected function leaveOptimizeFor(Twig_NodeInterface $spcefb62, Twig_Environment $spf4b92b) { if ($spcefb62 instanceof Twig_Node_For) { array_shift($this->loops); array_shift($this->loopsTargets); array_shift($this->loopsTargets); } } protected function addLoopToCurrent() { $this->loops[0]->setAttribute('with_loop', true); } protected function addLoopToAll() { foreach ($this->loops as $spa410c6) { $spa410c6->setAttribute('with_loop', true); } } public function getPriority() { return 255; } }