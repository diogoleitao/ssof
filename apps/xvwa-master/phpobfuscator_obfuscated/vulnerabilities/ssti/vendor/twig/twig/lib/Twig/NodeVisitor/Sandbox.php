<?php
class Twig_NodeVisitor_Sandbox implements Twig_NodeVisitorInterface { protected $inAModule = false; protected $tags; protected $filters; protected $functions; public function enterNode(Twig_NodeInterface $spcefb62, Twig_Environment $spf4b92b) { if ($spcefb62 instanceof Twig_Node_Module) { $this->inAModule = true; $this->tags = array(); $this->filters = array(); $this->functions = array(); return $spcefb62; } elseif ($this->inAModule) { if ($spcefb62->getNodeTag() && !isset($this->tags[$spcefb62->getNodeTag()])) { $this->tags[$spcefb62->getNodeTag()] = $spcefb62; } if ($spcefb62 instanceof Twig_Node_Expression_Filter && !isset($this->filters[$spcefb62->getNode('filter')->getAttribute('value')])) { $this->filters[$spcefb62->getNode('filter')->getAttribute('value')] = $spcefb62; } if ($spcefb62 instanceof Twig_Node_Expression_Function && !isset($this->functions[$spcefb62->getAttribute('name')])) { $this->functions[$spcefb62->getAttribute('name')] = $spcefb62; } if ($spcefb62 instanceof Twig_Node_Print) { return new Twig_Node_SandboxedPrint($spcefb62->getNode('expr'), $spcefb62->getLine(), $spcefb62->getNodeTag()); } } return $spcefb62; } public function leaveNode(Twig_NodeInterface $spcefb62, Twig_Environment $spf4b92b) { if ($spcefb62 instanceof Twig_Node_Module) { $this->inAModule = false; $spcefb62->setNode('display_start', new Twig_Node(array(new Twig_Node_CheckSecurity($this->filters, $this->tags, $this->functions), $spcefb62->getNode('display_start')))); } return $spcefb62; } public function getPriority() { return 0; } }