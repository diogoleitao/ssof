<?php
class Twig_Parser implements Twig_ParserInterface { protected $stack = array(); protected $stream; protected $parent; protected $handlers; protected $visitors; protected $expressionParser; protected $blocks; protected $blockStack; protected $macros; protected $env; protected $reservedMacroNames; protected $importedSymbols; protected $traits; protected $embeddedTemplates = array(); public function __construct(Twig_Environment $spf4b92b) { $this->env = $spf4b92b; } public function getEnvironment() { return $this->env; } public function getVarName() { return sprintf('__internal_%s', hash('sha256', uniqid(mt_rand(), true), false)); } public function getFilename() { return $this->stream->getFilename(); } public function parse(Twig_TokenStream $sp8ec2ac, $sp26d1b4 = null, $sp8b3f9d = false) { $sp6f9980 = get_object_vars($this); unset($sp6f9980['stack'], $sp6f9980['env'], $sp6f9980['handlers'], $sp6f9980['visitors'], $sp6f9980['expressionParser']); $this->stack[] = $sp6f9980; if (null === $this->handlers) { $this->handlers = $this->env->getTokenParsers(); $this->handlers->setParser($this); } if (null === $this->visitors) { $this->visitors = $this->env->getNodeVisitors(); } if (null === $this->expressionParser) { $this->expressionParser = new Twig_ExpressionParser($this, $this->env->getUnaryOperators(), $this->env->getBinaryOperators()); } $this->stream = $sp8ec2ac; $this->parent = null; $this->blocks = array(); $this->macros = array(); $this->traits = array(); $this->blockStack = array(); $this->importedSymbols = array(array()); $this->embeddedTemplates = array(); try { $sp1965de = $this->subparse($sp26d1b4, $sp8b3f9d); if (null !== $this->parent) { if (null === ($sp1965de = $this->filterBodyNodes($sp1965de))) { $sp1965de = new Twig_Node(); } } } catch (Twig_Error_Syntax $spbcee8e) { if (!$spbcee8e->getTemplateFile()) { $spbcee8e->setTemplateFile($this->getFilename()); } if (!$spbcee8e->getTemplateLine()) { $spbcee8e->setTemplateLine($this->stream->getCurrent()->getLine()); } throw $spbcee8e; } $spcefb62 = new Twig_Node_Module(new Twig_Node_Body(array($sp1965de)), $this->parent, new Twig_Node($this->blocks), new Twig_Node($this->macros), new Twig_Node($this->traits), $this->embeddedTemplates, $this->getFilename()); $sp58ae2d = new Twig_NodeTraverser($this->env, $this->visitors); $spcefb62 = $sp58ae2d->traverse($spcefb62); foreach (array_pop($this->stack) as $spd888fc => $sp627729) { $this->{$spd888fc} = $sp627729; } return $spcefb62; } public function subparse($sp26d1b4, $sp8b3f9d = false) { $sp1f599c = $this->getCurrentToken()->getLine(); $sp49303a = array(); while (!$this->stream->isEOF()) { switch ($this->getCurrentToken()->getType()) { case Twig_Token::TEXT_TYPE: $sp650e38 = $this->stream->next(); $sp49303a[] = new Twig_Node_Text($sp650e38->getValue(), $sp650e38->getLine()); break; case Twig_Token::VAR_START_TYPE: $sp650e38 = $this->stream->next(); $sp005e3e = $this->expressionParser->parseExpression(); $this->stream->expect(Twig_Token::VAR_END_TYPE); $sp49303a[] = new Twig_Node_Print($sp005e3e, $sp650e38->getLine()); break; case Twig_Token::BLOCK_START_TYPE: $this->stream->next(); $sp650e38 = $this->getCurrentToken(); if ($sp650e38->getType() !== Twig_Token::NAME_TYPE) { throw new Twig_Error_Syntax('A block must start with a tag name', $sp650e38->getLine(), $this->getFilename()); } if (null !== $sp26d1b4 && call_user_func($sp26d1b4, $sp650e38)) { if ($sp8b3f9d) { $this->stream->next(); } if (1 === count($sp49303a)) { return $sp49303a[0]; } return new Twig_Node($sp49303a, array(), $sp1f599c); } $spb154da = $this->handlers->getTokenParser($sp650e38->getValue()); if (null === $spb154da) { if (null !== $sp26d1b4) { $sp4eefd6 = sprintf('Unexpected tag name "%s"', $sp650e38->getValue()); if (is_array($sp26d1b4) && isset($sp26d1b4[0]) && $sp26d1b4[0] instanceof Twig_TokenParserInterface) { $sp4eefd6 .= sprintf(' (expecting closing tag for the "%s" tag defined near line %s)', $sp26d1b4[0]->getTag(), $sp1f599c); } throw new Twig_Error_Syntax($sp4eefd6, $sp650e38->getLine(), $this->getFilename()); } $sp9f2d02 = sprintf('Unknown tag name "%s"', $sp650e38->getValue()); if ($sp249a0e = $this->env->computeAlternatives($sp650e38->getValue(), array_keys($this->env->getTags()))) { $sp9f2d02 = sprintf('%s. Did you mean "%s"', $sp9f2d02, implode('", "', $sp249a0e)); } throw new Twig_Error_Syntax($sp9f2d02, $sp650e38->getLine(), $this->getFilename()); } $this->stream->next(); $spcefb62 = $spb154da->parse($sp650e38); if (null !== $spcefb62) { $sp49303a[] = $spcefb62; } break; default: throw new Twig_Error_Syntax('Lexer or parser ended up in unsupported state.', 0, $this->getFilename()); } } if (1 === count($sp49303a)) { return $sp49303a[0]; } return new Twig_Node($sp49303a, array(), $sp1f599c); } public function addHandler($sp3eec35, $spbd0159) { $this->handlers[$sp3eec35] = $spbd0159; } public function addNodeVisitor(Twig_NodeVisitorInterface $sp0bf47c) { $this->visitors[] = $sp0bf47c; } public function getBlockStack() { return $this->blockStack; } public function peekBlockStack() { return $this->blockStack[count($this->blockStack) - 1]; } public function popBlockStack() { array_pop($this->blockStack); } public function pushBlockStack($sp3eec35) { $this->blockStack[] = $sp3eec35; } public function hasBlock($sp3eec35) { return isset($this->blocks[$sp3eec35]); } public function getBlock($sp3eec35) { return $this->blocks[$sp3eec35]; } public function setBlock($sp3eec35, Twig_Node_Block $spbb4d96) { $this->blocks[$sp3eec35] = new Twig_Node_Body(array($spbb4d96), array(), $spbb4d96->getLine()); } public function hasMacro($sp3eec35) { return isset($this->macros[$sp3eec35]); } public function setMacro($sp3eec35, Twig_Node_Macro $spcefb62) { if (null === $this->reservedMacroNames) { $this->reservedMacroNames = array(); $sp693624 = new ReflectionClass($this->env->getBaseTemplateClass()); foreach ($sp693624->getMethods() as $sp810c92) { $this->reservedMacroNames[] = $sp810c92->getName(); } } if (in_array($sp3eec35, $this->reservedMacroNames)) { throw new Twig_Error_Syntax(sprintf('"%s" cannot be used as a macro name as it is a reserved keyword', $sp3eec35), $spcefb62->getLine(), $this->getFilename()); } $this->macros[$sp3eec35] = $spcefb62; } public function addTrait($sp06a7e9) { $this->traits[] = $sp06a7e9; } public function hasTraits() { return count($this->traits) > 0; } public function embedTemplate(Twig_Node_Module $spe32893) { $spe32893->setIndex(mt_rand()); $this->embeddedTemplates[] = $spe32893; } public function addImportedSymbol($sp32ff7e, $sp752449, $sp3eec35 = null, Twig_Node_Expression $spcefb62 = null) { $this->importedSymbols[0][$sp32ff7e][$sp752449] = array('name' => $sp3eec35, 'node' => $spcefb62); } public function getImportedSymbol($sp32ff7e, $sp752449) { foreach ($this->importedSymbols as $spbe1c61) { if (isset($spbe1c61[$sp32ff7e][$sp752449])) { return $spbe1c61[$sp32ff7e][$sp752449]; } } } public function isMainScope() { return 1 === count($this->importedSymbols); } public function pushLocalScope() { array_unshift($this->importedSymbols, array()); } public function popLocalScope() { array_shift($this->importedSymbols); } public function getExpressionParser() { return $this->expressionParser; } public function getParent() { return $this->parent; } public function setParent($sped512c) { $this->parent = $sped512c; } public function getStream() { return $this->stream; } public function getCurrentToken() { return $this->stream->getCurrent(); } protected function filterBodyNodes(Twig_NodeInterface $spcefb62) { if ($spcefb62 instanceof Twig_Node_Text && !ctype_space($spcefb62->getAttribute('data')) || !$spcefb62 instanceof Twig_Node_Text && !$spcefb62 instanceof Twig_Node_BlockReference && $spcefb62 instanceof Twig_NodeOutputInterface) { if (false !== strpos((string) $spcefb62, chr(239) . chr(187) . chr(191))) { throw new Twig_Error_Syntax('A template that extends another one cannot have a body but a byte order mark (BOM) has been detected; it must be removed.', $spcefb62->getLine(), $this->getFilename()); } throw new Twig_Error_Syntax('A template that extends another one cannot have a body.', $spcefb62->getLine(), $this->getFilename()); } if ($spcefb62 instanceof Twig_Node_Set) { return $spcefb62; } if ($spcefb62 instanceof Twig_NodeOutputInterface) { return; } foreach ($spcefb62 as $sp0fcc28 => $sp96b41e) { if (null !== $sp96b41e && null === $this->filterBodyNodes($sp96b41e)) { $spcefb62->removeNode($sp0fcc28); } } return $spcefb62; } }