<?php
class Twig_NodeVisitor_Escaper implements Twig_NodeVisitorInterface { protected $statusStack = array(); protected $blocks = array(); protected $safeAnalysis; protected $traverser; protected $defaultStrategy = false; protected $safeVars = array(); public function __construct() { $this->safeAnalysis = new Twig_NodeVisitor_SafeAnalysis(); } public function enterNode(Twig_NodeInterface $spcefb62, Twig_Environment $spf4b92b) { if ($spcefb62 instanceof Twig_Node_Module) { if ($spf4b92b->hasExtension('escaper') && ($spb8ce30 = $spf4b92b->getExtension('escaper')->getDefaultStrategy($spcefb62->getAttribute('filename')))) { $this->defaultStrategy = $spb8ce30; } $this->safeVars = array(); } elseif ($spcefb62 instanceof Twig_Node_AutoEscape) { $this->statusStack[] = $spcefb62->getAttribute('value'); } elseif ($spcefb62 instanceof Twig_Node_Block) { $this->statusStack[] = isset($this->blocks[$spcefb62->getAttribute('name')]) ? $this->blocks[$spcefb62->getAttribute('name')] : $this->needEscaping($spf4b92b); } elseif ($spcefb62 instanceof Twig_Node_Import) { $this->safeVars[] = $spcefb62->getNode('var')->getAttribute('name'); } return $spcefb62; } public function leaveNode(Twig_NodeInterface $spcefb62, Twig_Environment $spf4b92b) { if ($spcefb62 instanceof Twig_Node_Module) { $this->defaultStrategy = false; $this->safeVars = array(); } elseif ($spcefb62 instanceof Twig_Node_Expression_Filter) { return $this->preEscapeFilterNode($spcefb62, $spf4b92b); } elseif ($spcefb62 instanceof Twig_Node_Print) { return $this->escapePrintNode($spcefb62, $spf4b92b, $this->needEscaping($spf4b92b)); } if ($spcefb62 instanceof Twig_Node_AutoEscape || $spcefb62 instanceof Twig_Node_Block) { array_pop($this->statusStack); } elseif ($spcefb62 instanceof Twig_Node_BlockReference) { $this->blocks[$spcefb62->getAttribute('name')] = $this->needEscaping($spf4b92b); } return $spcefb62; } protected function escapePrintNode(Twig_Node_Print $spcefb62, Twig_Environment $spf4b92b, $sp32ff7e) { if (false === $sp32ff7e) { return $spcefb62; } $spedbef4 = $spcefb62->getNode('expr'); if ($this->isSafeFor($sp32ff7e, $spedbef4, $spf4b92b)) { return $spcefb62; } $spbd0159 = get_class($spcefb62); return new $spbd0159($this->getEscaperFilter($sp32ff7e, $spedbef4), $spcefb62->getLine()); } protected function preEscapeFilterNode(Twig_Node_Expression_Filter $sp4a901b, Twig_Environment $spf4b92b) { $sp3eec35 = $sp4a901b->getNode('filter')->getAttribute('value'); $sp32ff7e = $spf4b92b->getFilter($sp3eec35)->getPreEscape(); if (null === $sp32ff7e) { return $sp4a901b; } $spcefb62 = $sp4a901b->getNode('node'); if ($this->isSafeFor($sp32ff7e, $spcefb62, $spf4b92b)) { return $sp4a901b; } $sp4a901b->setNode('node', $this->getEscaperFilter($sp32ff7e, $spcefb62)); return $sp4a901b; } protected function isSafeFor($sp32ff7e, Twig_NodeInterface $spedbef4, $spf4b92b) { $spc4c9ef = $this->safeAnalysis->getSafe($spedbef4); if (null === $spc4c9ef) { if (null === $this->traverser) { $this->traverser = new Twig_NodeTraverser($spf4b92b, array($this->safeAnalysis)); } $this->safeAnalysis->setSafeVars($this->safeVars); $this->traverser->traverse($spedbef4); $spc4c9ef = $this->safeAnalysis->getSafe($spedbef4); } return in_array($sp32ff7e, $spc4c9ef) || in_array('all', $spc4c9ef); } protected function needEscaping(Twig_Environment $spf4b92b) { if (count($this->statusStack)) { return $this->statusStack[count($this->statusStack) - 1]; } return $this->defaultStrategy ? $this->defaultStrategy : false; } protected function getEscaperFilter($sp32ff7e, Twig_NodeInterface $spcefb62) { $sp1a6fde = $spcefb62->getLine(); $sp3eec35 = new Twig_Node_Expression_Constant('escape', $sp1a6fde); $spbd325e = new Twig_Node(array(new Twig_Node_Expression_Constant((string) $sp32ff7e, $sp1a6fde), new Twig_Node_Expression_Constant(null, $sp1a6fde), new Twig_Node_Expression_Constant(true, $sp1a6fde))); return new Twig_Node_Expression_Filter($spcefb62, $sp3eec35, $spbd325e, $sp1a6fde); } public function getPriority() { return 0; } }