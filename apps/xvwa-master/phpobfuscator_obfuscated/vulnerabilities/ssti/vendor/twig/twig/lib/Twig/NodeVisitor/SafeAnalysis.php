<?php
class Twig_NodeVisitor_SafeAnalysis implements Twig_NodeVisitorInterface { protected $data = array(); protected $safeVars = array(); public function setSafeVars($spaee19d) { $this->safeVars = $spaee19d; } public function getSafe(Twig_NodeInterface $spcefb62) { $spf9e630 = spl_object_hash($spcefb62); if (!isset($this->data[$spf9e630])) { return; } foreach ($this->data[$spf9e630] as $spab853d) { if ($spab853d['key'] !== $spcefb62) { continue; } if (in_array('html_attr', $spab853d['value'])) { $spab853d['value'][] = 'html'; } return $spab853d['value']; } } protected function setSafe(Twig_NodeInterface $spcefb62, array $spc4c9ef) { $spf9e630 = spl_object_hash($spcefb62); if (isset($this->data[$spf9e630])) { foreach ($this->data[$spf9e630] as &$spab853d) { if ($spab853d['key'] === $spcefb62) { $spab853d['value'] = $spc4c9ef; return; } } } $this->data[$spf9e630][] = array('key' => $spcefb62, 'value' => $spc4c9ef); } public function enterNode(Twig_NodeInterface $spcefb62, Twig_Environment $spf4b92b) { return $spcefb62; } public function leaveNode(Twig_NodeInterface $spcefb62, Twig_Environment $spf4b92b) { if ($spcefb62 instanceof Twig_Node_Expression_Constant) { $this->setSafe($spcefb62, array('all')); } elseif ($spcefb62 instanceof Twig_Node_Expression_BlockReference) { $this->setSafe($spcefb62, array('all')); } elseif ($spcefb62 instanceof Twig_Node_Expression_Parent) { $this->setSafe($spcefb62, array('all')); } elseif ($spcefb62 instanceof Twig_Node_Expression_Conditional) { $spc4c9ef = $this->intersectSafe($this->getSafe($spcefb62->getNode('expr2')), $this->getSafe($spcefb62->getNode('expr3'))); $this->setSafe($spcefb62, $spc4c9ef); } elseif ($spcefb62 instanceof Twig_Node_Expression_Filter) { $sp3eec35 = $spcefb62->getNode('filter')->getAttribute('value'); $spbd325e = $spcefb62->getNode('arguments'); if (false !== ($sp4a901b = $spf4b92b->getFilter($sp3eec35))) { $spc4c9ef = $sp4a901b->getSafe($spbd325e); if (null === $spc4c9ef) { $spc4c9ef = $this->intersectSafe($this->getSafe($spcefb62->getNode('node')), $sp4a901b->getPreservesSafety()); } $this->setSafe($spcefb62, $spc4c9ef); } else { $this->setSafe($spcefb62, array()); } } elseif ($spcefb62 instanceof Twig_Node_Expression_Function) { $sp3eec35 = $spcefb62->getAttribute('name'); $spbd325e = $spcefb62->getNode('arguments'); $sp9b51b9 = $spf4b92b->getFunction($sp3eec35); if (false !== $sp9b51b9) { $this->setSafe($spcefb62, $sp9b51b9->getSafe($spbd325e)); } else { $this->setSafe($spcefb62, array()); } } elseif ($spcefb62 instanceof Twig_Node_Expression_MethodCall) { if ($spcefb62->getAttribute('safe')) { $this->setSafe($spcefb62, array('all')); } else { $this->setSafe($spcefb62, array()); } } elseif ($spcefb62 instanceof Twig_Node_Expression_GetAttr && $spcefb62->getNode('node') instanceof Twig_Node_Expression_Name) { $sp3eec35 = $spcefb62->getNode('node')->getAttribute('name'); if ('_self' == $sp3eec35 || in_array($sp3eec35, $this->safeVars)) { $this->setSafe($spcefb62, array('all')); } else { $this->setSafe($spcefb62, array()); } } else { $this->setSafe($spcefb62, array()); } return $spcefb62; } protected function intersectSafe(array $spda7027 = null, array $sp607ff1 = null) { if (null === $spda7027 || null === $sp607ff1) { return array(); } if (in_array('all', $spda7027)) { return $sp607ff1; } if (in_array('all', $sp607ff1)) { return $spda7027; } return array_intersect($spda7027, $sp607ff1); } public function getPriority() { return 0; } }